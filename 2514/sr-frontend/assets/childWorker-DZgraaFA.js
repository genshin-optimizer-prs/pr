(function(){"use strict";function E(e){throw new Error(`Should not reach this with value ${e}`)}function w(e,s){const n=new Set;function o(i){n.has(i)||(s(i,o),n.add(i))}e.forEach(o)}function x(e,s,n,o,i=""){let h=1,t="'use strict';"+i+";const x0=0";const l=new Map;return w(e,(a,f)=>{const r=`x${h++}`;l.set(a,r);const{op:$,x:m,br:S}=a;m.forEach(f),S.forEach(f);const c=m.map(d=>l.get(d)),p=S.map(d=>l.get(d));switch($){case"const":l.set(a,typeof a.ex!="string"?`(${a.ex})`:`('${a.ex}')`);break;case"sum":case"prod":t+=`,${r}=`,c.length?t+=c.join($=="sum"?"+":"*"):t+=$=="sum"?0:1;break;case"min":case"max":t+=`,${r}=Math.${$}(${c})`;break;case"sumfrac":t+=`,${r}=${c[0]}/(${c[0]} + ${c[1]})`;break;case"match":t+=`,${r}=${p[0]}===${p[1]}?${c[0]}:${c[1]}`;break;case"thres":t+=`,${r}=${p[0]}>=${p[1]}?${c[0]}:${c[1]}`;break;case"subscript":t+=`,${r}=${JSON.stringify(a.ex)}[${p[0]}]`;break;case"read":{const d=a.tag[s];let g=[...new Array(n)].map((_,T)=>`(b[${T}]['${d}'] ?? 0)`);o[d]&&(g=[o[d].toString(),...g]),t+=`,${r}=${g.join("+")}`;break}case"custom":t+=`,${r}=${a.ex}(${c})`;break;case"lookup":t+=`,${r}=([${c}])[(${JSON.stringify(a.ex)})[${p[0]}] ?? 0]`;break;default:E($)}}),t+=`;return [${e.map(a=>l.get(a))}]`,new Function("b",t)}const b=5e4,M=2e5;let y,u,k=[];onmessage=async e=>{try{await B(e)}catch(s){console.log(s),postMessage({resultType:"err",message:JSON.stringify(s)})}};async function B(e){const{data:s}=e,{command:n}=s;switch(n){case"init":N(s);break;case"start":await v();break}}async function N({relicStatsBySlot:e,detachedNodes:s,constraints:n}){y=x(s,"q",6,{}),u=e,k=n,postMessage({resultType:"initialized"})}async function v(){let e=[],s=0;function n(){const o=e.length;e.length>b&&(e.sort((i,h)=>h.value-i.value),e=e.slice(0,b)),postMessage({resultType:"results",builds:e,numBuildsComputed:o+s}),e=[],s=0}u.head.forEach(o=>{u.hands.forEach(i=>{u.feet.forEach(h=>{u.body.forEach(t=>{u.sphere.forEach(l=>{u.rope.forEach(a=>{const f=y([o.stats,i.stats,h.stats,t.stats,l.stats,a.stats]);k.every(({value:r,isMax:$},m)=>$?f[m+1]<=r:f[m+1]>=r)?e.push({value:f[0],ids:{head:o.id,hands:i.id,feet:h.id,body:t.id,sphere:l.id,rope:a.id}}):s++,e.length>M&&n()})})})})})}),e.length>0&&n(),postMessage({resultType:"done"})}})();
